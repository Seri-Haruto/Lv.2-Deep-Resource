<!doctype html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ありがとうございました｜心のぐるぐる描画</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
</head>
<body>
  <main class="container container--narrow">
    <section class="card center-card">
      <div class="head"><h2>ご協力ありがとうございました</h2></div>
      <div class="body" style="text-align:center;">
        <p>全10回の提出が完了しました．研究にご協力いただきありがとうございます．</p>

        <hr class="sep">

        <h3 class="mt-8">クラウドワークスへの入力</h3>
        <p class="cw-lead">下の<strong>合言葉</strong>と<strong>参加者ID</strong>を作業完了画面にそれぞれ入力してください．</p>

        <!-- 合言葉 -->
        <div class="info-box">
          <div class="info-box__label">合言葉</div>
          <div class="info-box__value">
            <span id="cwKeyword">どら焼き</span>
            <button class="copy-btn copy-btn--icon" data-copy="#cwKeyword" aria-label="合言葉をコピー">📋</button>
          </div>
        </div>

        <!-- 参加者ID -->
        <div class="info-box">
          <div class="info-box__label">参加者ID</div>
          <div class="info-box__value">
            <span id="finalId">---</span>
            <button class="copy-btn copy-btn--icon" data-copy="#finalId" aria-label="参加者IDをコピー">📋</button>
          </div>
        </div>

        <div id="copyToast" class="copy-toast" aria-live="polite" aria-hidden="true">コピーしました</div>
      </div>
    </section>

    <!-- 枠外・小さめの撤回申請（中央配置・3日以内明示） -->
    <div class="withdraw-cta">
      <a class="btn tiny ghost" href="/withdraw">データ撤回を申請</a>
      <span class="small dim">（<strong>3日以内</strong>・参加者IDが必要）</span>
    </div>
  </main>

  <footer class="container container--narrow"><small>© 2025 Osawa Lab</small></footer>

  <script>
  (function(){
    const MAX_TRIALS = 10;

    // 参加者ID（必須）
    const pid = localStorage.getItem('participant_id') || '未発行';

    // trial_count は「参加者ID:trial_count」を優先、なければ旧キーも見る
    const ns = parseInt(localStorage.getItem(pid + ':trial_count') || 'NaN', 10);
    const legacy = parseInt(localStorage.getItem('trial_count') || 'NaN', 10);
    const tc = Number.isFinite(ns) ? ns : (Number.isFinite(legacy) ? legacy : 0);

    // trap 消化の確認（submit_count か trap_done で判定）
    const nsSubmit = parseInt(localStorage.getItem(pid + ':submit_count') || 'NaN', 10);
    const legacySubmit = parseInt(localStorage.getItem('submit_count') || 'NaN', 10);
    const submitCount = Number.isFinite(nsSubmit) ? nsSubmit :
                        (Number.isFinite(legacySubmit) ? legacySubmit : 0);
    const trapDone = (localStorage.getItem(pid + ':trap_done') === 'true') ||
                     (localStorage.getItem('trap_done') === 'true');

    // 10回未満 or trap未消化なら draw へ戻す（往復防止の肝）
    if (!(tc >= MAX_TRIALS && trapDone)) {
      location.href = '/draw';
      return;
    }

    // 表示
    document.getElementById('finalId').textContent = pid;

    // コピーUI
    const toast = document.getElementById('copyToast');
    function showToast(){
      toast.setAttribute('aria-hidden','false');
      toast.classList.add('show');
      setTimeout(()=>{ toast.classList.remove('show'); toast.setAttribute('aria-hidden','true'); }, 1100);
    }
    document.querySelectorAll('.copy-btn[data-copy]').forEach(btn=>{
      btn.addEventListener('click', async ()=>{
        const el = document.querySelector(btn.getAttribute('data-copy'));
        const text = (el?.textContent || '').trim();
        try { await navigator.clipboard.writeText(text); }
        catch {
          const ta = document.createElement('textarea'); ta.value = text;
          document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove();
        }
        showToast();
      });
    });
  })();
</script>

</body>
</html>
